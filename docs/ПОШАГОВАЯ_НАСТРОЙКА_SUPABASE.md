# Пошаговая настройка хранилища CRM в Supabase

## Шаг 1. Создать проект в Supabase

1. Зайдите на [https://supabase.com](https://supabase.com) и войдите в аккаунт (или зарегистрируйтесь).
2. Нажмите **New project**.
3. Укажите:
   - **Name** — любое имя (например, `crm-11`).
   - **Database Password** — придумайте и сохраните надёжный пароль (он нужен для доступа к БД).
   - **Region** — выберите ближайший регион.
4. Нажмите **Create new project** и дождитесь создания (1–2 минуты).

---

## Шаг 2. Скопировать ключи и URL

1. В левом меню проекта откройте **Settings** (иконка шестерёнки).
2. Выберите **API**.
3. Скопируйте и сохраните в блокнот:
   - **Project URL** — это ваш `NEXT_PUBLIC_SUPABASE_URL`.
   - **anon public** (ключ в разделе Project API keys) — это `NEXT_PUBLIC_SUPABASE_ANON_KEY`.
   - **service_role** (там же, можно нажать Reveal) — это `SUPABASE_SERVICE_ROLE_KEY`.  
     ⚠️ Никому не показывайте и не выкладывайте `service_role` в интернет.

---

## Шаг 3. Добавить переменные в .env.local

1. В корне проекта откройте файл `.env.local` (если его нет — создайте).
2. Добавьте или проверьте строки (подставьте свои значения из шага 2):

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxxxxxxxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

3. Сохраните файл.

---

## Шаг 4. Применить миграции в Supabase

1. В Supabase откройте **SQL Editor** (иконка </> в левом меню).
2. Нажмите **New query**.

**Миграция 1 — основная схема**

3. Откройте в проекте файл `supabase/migrations/20260215000000_crm_schema.sql`.
4. Скопируйте **весь** текст файла (Ctrl+A → Ctrl+C).
5. Вставьте в окно SQL Editor в Supabase и нажмите **Run** (или Ctrl+Enter).
6. Внизу должно появиться сообщение об успешном выполнении (без красных ошибок).

**Миграция 2 — учётки операторов**

7. Снова **New query**.
8. Откройте `supabase/migrations/20260220000000_operator_accounts.sql`, скопируйте весь файл, вставьте в SQL Editor и нажмите **Run**.

**Миграция 3 — статус операторов**

9. **New query** → откройте `supabase/migrations/20260220000000_crm_operators_status.sql` → скопируйте всё → вставьте → **Run**.

**Миграция 4 — доступ операторов к сменам**

10. **New query** → откройте `supabase/migrations/20260220100000_operator_shifts_rls.sql` → скопируйте всё → вставьте → **Run**.

После этого все таблицы CRM и политики RLS будут созданы.

---

## Шаг 5. Создать пользователя-владельца CRM

1. В корне проекта запустите приложение:
   ```bash
   npm run dev
   ```
2. Дождитесь запуска (обычно `http://localhost:3000`).
3. В PowerShell выполните один раз (секрет для dev по умолчанию `владелец2025`):

   ```powershell
   Invoke-WebRequest -Uri http://localhost:3000/api/setup-create-owner -Method POST -Headers @{"x-setup-secret"="владелец2025"}
   ```

   Или в cmd / терминале с curl:

   ```bash
   curl -X POST http://localhost:3000/api/setup-create-owner -H "x-setup-secret: владелец2025"
   ```

4. В ответе должно быть сообщение вроде: «Владелец создан» или «Пользователь с таким email уже создан».

Логин владельца: **anglijskogoucitel2@gmail.com**  
Пароль: **170100den**

---

## Шаг 6. Проверить вход и сохранение данных

1. В браузере откройте [http://localhost:3000/login](http://localhost:3000/login).
2. Введите:
   - Email: `anglijskogoucitel2@gmail.com`
   - Пароль: `170100den`
3. Нажмите **Войти** — должен открыться дашборд с полным меню (Операторы, Модели, Смены, Финансы и т.д.).
4. Добавьте, например, оператора или модель и сохраните.
5. Обновите страницу (F5) — данные должны остаться (они уже в Supabase).

Готово. Дальше все данные при работе под этим логином хранятся в Supabase.

---

## Краткий чеклист

- [ ] Создан проект в Supabase  
- [ ] Скопированы Project URL, anon key, service_role key  
- [ ] В `.env.local` прописаны `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`  
- [ ] Выполнены 4 миграции в SQL Editor по порядку  
- [ ] Вызван `POST /api/setup-create-owner` с заголовком `x-setup-secret: владелец2025`  
- [ ] Вход на /login под владельцем прошёл успешно  
- [ ] После добавления данных и обновления страницы данные сохраняются  

---

## Если что-то пошло не так

- **Ошибка при Run в SQL Editor** — проверьте, что миграции запускались по порядку (сначала 20260215, потом 20260220, затем 202602201).
- **«Сервис недоступен» при входе** — проверьте `.env.local` и перезапустите `npm run dev`.
- **Неверные учётные данные при входе** — убедитесь, что шаг 5 выполнен и в ответе было создание/существование пользователя.
- **Данные не сохраняются** — убедитесь, что все 4 миграции выполнены без ошибок и вы залогинены под владельцем.
