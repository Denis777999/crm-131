# Перенос данных и настройка CRM в Supabase

Чтобы основная CRM-система работала корректно (в том числе **локально на http://localhost:3000/dashboard**), все данные должны храниться в Supabase. Пошаговая настройка для localhost: [LOCALHOST_SUPABASE.md](./LOCALHOST_SUPABASE.md).

Кратко: схема (таблицы, RLS), цели дашборда и данные пользователей (операторы, модели, смены и т.д.) создаются/читаются приложением через Supabase.

## Что нужно сделать в Supabase

### 1. Применить миграции (схема + начальные данные)

**Вариант A — один файл в SQL Editor (рекомендуется для быстрого старта)**

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard) → ваш проект.
2. Перейдите в **SQL Editor**.
3. Откройте файл `supabase/apply_all_migrations.sql` из репозитория, скопируйте весь текст и вставьте в редактор.
4. Нажмите **Run**. Выполнятся все миграции по порядку:
   - таблицы CRM (операторы, модели, пары, смены, настройки и т.д.);
   - учётные записи операторов и RLS для смен;
   - таблица `goals` и одна запись по умолчанию для дашборда.
5. Убедитесь, что выполнение прошло без ошибок.

**Вариант B — через Supabase CLI**

Если у вас настроен CLI и проект связан с репозиторием:

```bash
supabase db push
```

Будут применены все файлы из `supabase/migrations/` по имени (по порядку).

### 2. Проверить в дашборде Supabase

- **Table Editor**: должны быть таблицы `crm_operators`, `crm_models`, `crm_shifts`, `goals`, `crm_operator_accounts` и остальные из схемы.
- **Authentication**: пользователи регистрируются/логинятся через приложение — записей может ещё не быть.
- **goals**: в таблице `goals` должна быть хотя бы одна строка (создаётся миграцией). Дашборд CRM читает её для отображения целей и текущих показателей.

### 3. Переменные окружения приложения

В `.env.local` (или в настройках деплоя) должны быть заданы:

- `NEXT_PUBLIC_SUPABASE_URL` — URL проекта Supabase.
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` — anon (public) key.

После этого приложение будет читать и записывать все данные CRM в Supabase.

## Откуда берутся данные

- **Цели (goals)** — одна запись создаётся миграцией; дальше пользователи меняют её со страницы «Цели» в CRM.
- **Операторы, модели, пары, смены, комментарии, доступы** — создаются и редактируются пользователями через интерфейс CRM; все операции идут в Supabase через `lib/crmDb.ts`.
- **Учётные записи операторов** (`crm_operator_accounts`) — создаются владельцем CRM при выдаче оператору доступа (логин/пароль для входа в CRM).

После применения миграций дополнительный перенос данных не требуется: приложение уже настроено на работу с Supabase. Если у вас есть старые данные в другом источнике (Excel, другая БД), их нужно импортировать отдельно (например, скриптом или вручную через Table Editor / API).

## Порядок миграций (если запускаете по отдельности)

1. `20260215000000_crm_schema.sql` — базовая схема CRM и RLS.
2. `20260220000000_operator_accounts.sql` — учётки операторов.
3. `20260220000000_crm_operators_status.sql` — колонка `status` у операторов.
4. `20260220100000_operator_shifts_rls.sql` — доступ операторов к сменам.
5. `20260226000000_model_responsible_operator.sql` — ответственный за модель.
6. `20260226100000_crm_operators_access.sql` — логин/пароль доступа в CRM.
7. `20260227000000_shift_check_calculated.sql` — расчёт чека по смене.
8. `20260228000000_goals.sql` — таблица целей и одна запись.
9. `20260228100000_goals_add_current_columns.sql` — доп. колонки в `goals`.

Или один раз выполните `apply_all_migrations.sql` — в нём тот же порядок.
